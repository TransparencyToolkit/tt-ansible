---
# https://github.com/TransparencyToolkit/IndexServer
# requires curl
#  Ensure curl is installed and that the doc_integrity_check and curb gems are installed.

- name: Fetch IndexServer source code
  register: indexserver
  async: 3600
  poll: 10
  git:
    depth: 1
    dest: IndexServer
    repo: https://github.com/TransparencyToolkit/IndexServer
    umask: "0077"

- name: Install required gems
  become: true
  command: bash -lc 'gem install doc_integrity_check curb sinatra'

- name: Wait for git repos to sync
  async_status:
    jid: "{{ indexserver.ansible_job_id }}"
  retries: 60
  delay: 60
  until: indexserver.finished

# TODO: In config.ru, set the DOCMANAGER_URL environment variable to the url
#       for DocManager
# ENV["DOCMANAGER_URL"] = "http://localhost:3000"

#- name: Bring it up
#  command: chdir=IndexServer bash -lc 'rackup -p 9494'
