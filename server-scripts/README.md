## Server scripts

This directory contains scripts for running a server that creates KVM VMs
containing the various TT tools, called "instances,"
controlled by an ArchiveAdministrator ("AA") VM.

On the host-side an nginx instance takes care of forwarding HTTP requests to
the VMs.

## Installation instructions

1) The first step for installing the host-side tools is to run this command in the root of this repository:
```shell
make server
```

These scripts use the `10.0.0.0/8` IP range for internal addressing.

2) Uncomment the line containing `bind-interfaces` in `/etc/dnsmasq.conf`

3) `systemctl restart libvirtd`

4) `virsh net-autostart default`

5) `mkdir /tt_archive_config /tt_ocr`

6) ensure there's a LVM volume group ("vg") called `storage` with at
   least 100 GB disk space.
   If you don't have a partition to use with `pvcreate /path/to/partition`
   You can create a loopback-mounted file for this:
   `truncate -s 150g storage.file && pvcreate /dev/loop0`
   then `vgcreate storage /dev/loop0`

7) Make sure there's a `/root/.ssh/authorized_keys` file containing the
   public SSH keys you want to use to log into the instances while they
   are running (or an empty file if you do not plan to do so)

8) Make a new template using [generate-template.sh](#generate-template.sh)

9) Start [instance-control.py](#instance-control.sh) after configuring the
   domains and template to be used.

## Debugging the services

- Console of a VM: `virsh console vm-foo_bla` (login with root / `LOCAL_UNIX_PASSWORD` from `generate-template.sh`)

- List all VMs: `virsh list --all`

- List of networks and MAC addresses associated with VM:
  `virsh domiflist 'vm-foo_bla'`

- Obtain LetsEncrypt certificate for a domain:
  `certbot --authenticator standalone --installer nginx -d demo.transparency.tools`

- Renewing LetsEncrypt certificates:
  `certbot --authenticator nginx --installer nginx renew`

- To log into a VM using SSH you can create an ssh client config like:
  ```
  host tt-server
    hostname 1.2.3.4
    user root
  host tt-foo
    proxyjump tt-server
    user root
    hostname 10.13.37.2
  ```

- Inside a VM:
  - As root
    - Status of specific job: `systemctl status docupload`
    - Logs from specific job: `journalctl -xeu docupload`
    - System status: `systemctl status`
    - Restarting a job: `systemctl restart docupload`
  - Anything to do with `ruby` or similar generally needs to be run as
    the `tt` user (which has password-less `sudo` access), so when logging
    in as root you can `su tt -l`
    - `pry ...` etc

## instance-control.py

This Python script handles:
- processing of commands from AA
  - creation of VMs
  - deletion of VMs
     - including calling [nuke-instance.sh](#nuke-instance.sh)
  - starting/stopping of VMs
- stopping the VMs running the OCR-related tools when no activity has been
  detected for `OCR_TIMEOUT_SECONDS`
- maintaining the nginx config
- acquiring LetsEncrypt X.509 certificates for use with HTTPS

It is configured through the use of global variables in the top of the script.
You will likely want to modify `TEMPLATE-NAME`, `INTERNAL_DOMAIN`,
and `PUBLIC_DOMAIN` there.

Usage (we recommend running this in a `tmux` session for now):
```shell
./instance-control.py
```

## nuke-instance.sh

Deletes various resources related to a VM:
- KVM VM instances
- KVM networks
- nginx configs for a VM
- configuration for a VM (generated by AA) in `/tt_archive_config/`
- LVM storage backing the VM in the `storage` volume group
- OCR-related storage for the VM in `/tt_ocr/`

Takes a single argument, which is the name of the VM as configured in AA.
Note that AA will mangle the name slightly.
You can obtain the list of VMs by running `virsh list --all`,
this script needs the name **without** the `vm-` prefix.


## generate-template.sh

Generates a template VM to be used when spawning new KVM VMs,
and an AA instance for the template.

The script takes two parameters:
- template name, ie `june19`
- template "range", which is used when configuring the IP prefix for
  the AA instance.
  It takes the form of a number between `1` and `255` inclusively.

An example of usage:
```shell
./generate-template june19 1
```

Some things are configured here that you may want to change:
```shell
# template by default gets 50g storage space
lvcreate -y --size 50g storage -n "${template}-template"

# allocate 10% of the space (allocated to the template) to the AA template:
lvcreate --snapshot --extents '10%ORIGIN' -n "admin-${template}" /dev/storage/${template}-template

```

## generate-instance.sh

Script called by [instance-control.py](#instance-control.py).

Creates COW snapshots of the specified template and configures them with
the parameters received from AA.

Two VMs are created: The "archive" VM and the "OCR" VM.

The disk space allocated to them is defined here, which you probably want
to change since the default of 15% of 50 GB is a little bit small:
```shell
lvcreate --snapshot --extents '15%ORIGIN' -n "${domain}" /dev/storage/${template}-template
lvcreate --snapshot --extents '15%ORIGIN' -n "${domain_ocr}" /dev/storage/${template}-template
```

## generate-public-instance.sh

Script called by [instance-control.py](#instance-control.py).

Very similar to [generate-instance.sh](#generate-instance.sh),
but creates a single new VM: The "public" VM which contains a LookingGlass
instance that receives files when the user clicks **"publish"** in the AA ui.
